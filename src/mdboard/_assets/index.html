<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task Board</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
(function() {
  var saved = localStorage.getItem('mdboard-theme');
  var theme = saved || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
  if (theme === 'light') document.documentElement.setAttribute('data-theme', 'light');
})();
</script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-base: #101014;
  --bg-surface: #17171e;
  --bg-overlay: #1e1e28;
  --bg-hover: #24242f;
  --bg-active: #2b2b38;
  --border: #2a2a35;
  --border-light: #353542;
  --text-primary: #e2e2e8;
  --text-secondary: #9494a3;
  --text-muted: #5f5f72;
  --text-accent: #7c8aff;
  --danger: #f85149;
  --accent-bg: rgba(124, 138, 255, 0.1);
  --accent-border: rgba(124, 138, 255, 0.2);
  --accent-bg-strong: rgba(124, 138, 255, 0.15);
  --accent-bg-hover: rgba(124, 138, 255, 0.25);
  --accent-border-strong: rgba(124, 138, 255, 0.3);
  --accent-subtle: rgba(124, 138, 255, 0.05);
  --accent-drag: rgba(124, 138, 255, 0.03);
  --danger-bg: rgba(248, 81, 73, 0.1);
  --danger-border: rgba(248, 81, 73, 0.2);
  --danger-bg-hover: rgba(248, 81, 73, 0.2);
  --diff-add-bg: rgba(16, 185, 129, 0.1);
  --diff-add-color: #6ee7b7;
  --diff-del-bg: rgba(248, 81, 73, 0.1);
  --diff-del-color: #fca5a1;
  --backdrop: rgba(0, 0, 0, 0.7);
  --color-prompt: #f59e0b;
  --color-document: #10b981;
  --font-ui: 'Inter', -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', 'SF Mono', monospace;
  --font: var(--font-ui);
}

[data-theme="light"] {
  --bg-base: #f4f4f7;
  --bg-surface: #ffffff;
  --bg-overlay: #eeeef2;
  --bg-hover: #e4e4ea;
  --bg-active: #d8d8e0;
  --border: #d0d0d8;
  --border-light: #bbbbc6;
  --text-primary: #1a1a2e;
  --text-secondary: #4a4a5e;
  --text-muted: #808096;
  --text-accent: #5b6abf;
  --danger: #dc3545;
  --accent-bg: rgba(91, 106, 191, 0.08);
  --accent-border: rgba(91, 106, 191, 0.2);
  --accent-bg-strong: rgba(91, 106, 191, 0.12);
  --accent-bg-hover: rgba(91, 106, 191, 0.18);
  --accent-border-strong: rgba(91, 106, 191, 0.3);
  --accent-subtle: rgba(91, 106, 191, 0.05);
  --accent-drag: rgba(91, 106, 191, 0.04);
  --danger-bg: rgba(220, 53, 69, 0.06);
  --danger-border: rgba(220, 53, 69, 0.18);
  --danger-bg-hover: rgba(220, 53, 69, 0.12);
  --diff-add-bg: rgba(16, 185, 129, 0.08);
  --diff-add-color: #047857;
  --diff-del-bg: rgba(220, 53, 69, 0.06);
  --diff-del-color: #b91c1c;
  --backdrop: rgba(0, 0, 0, 0.25);
  --color-prompt: #d97706;
  --color-document: #059669;
}

html, body {
  height: 100%;
  background: var(--bg-base);
  color: var(--text-primary);
  font-family: var(--font);
  font-size: 13px;
  line-height: 1.5;
  overflow: hidden;
}

/* ── HEADER ── */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  height: 52px;
  flex-shrink: 0;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.logo {
  font-weight: 700;
  font-size: 14px;
  letter-spacing: -0.02em;
  color: var(--text-primary);
}
.logo span { color: var(--text-muted); }
.logo .version { font-size: 10px; font-weight: 400; color: var(--text-muted); margin-left: 4px; }
.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}
.header-tabs {
  display: flex;
  gap: 2px;
}
.header-tab {
  padding: 5px 14px;
  background: none;
  border: 1px solid transparent;
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 12px;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s;
}
.header-tab:hover {
  color: var(--text-secondary);
}
.header-tab.active {
  color: var(--text-primary);
  border-color: var(--border);
  background: var(--bg-overlay);
}
.kbd {
  display: inline-flex;
  align-items: center;
  padding: 1px 6px;
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

/* ── FILTER BAR ── */
.filter-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}
.filter-bar label {
  color: var(--text-muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.filter-bar select, .filter-bar input {
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-ui);
  font-size: 12px;
  padding: 4px 8px;
  outline: none;
}
.filter-bar select:focus, .filter-bar input:focus {
  border-color: var(--text-accent);
}
.filter-bar select { cursor: pointer; }
.filter-group {
  display: flex;
  align-items: center;
  gap: 4px;
}
.filter-clear {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 11px;
  padding: 4px 8px;
  cursor: pointer;
}
.filter-clear:hover {
  border-color: var(--text-secondary);
  color: var(--text-secondary);
}
.scope-badge-bar {
  display: flex;
  align-items: center;
  gap: 5px;
  flex-wrap: wrap;
}
.scope-badge {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 500;
  letter-spacing: 0.02em;
  padding: 4px 12px;
  background: var(--bg-surface);
  color: var(--text-secondary);
  border: 1.5px solid var(--border-light);
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s, color 0.15s, box-shadow 0.15s;
  border-radius: 100px;
}
.scope-badge:hover {
  background: var(--bg-hover);
  border-color: var(--text-muted);
  color: var(--text-primary);
}
.scope-badge.active {
  background: var(--accent-bg-strong);
  border-color: var(--accent-border-strong);
  color: var(--text-accent);
  font-weight: 600;
  box-shadow: 0 0 0 1px var(--accent-border);
}
.scope-select-bar {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
  margin-top: 4px;
}
.scope-select-pill {
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 2px 8px;
  background: var(--bg-overlay);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  cursor: pointer;
  border-radius: 100px;
  transition: background 0.15s, border-color 0.15s, color 0.15s;
}
.scope-select-pill:hover {
  border-color: var(--text-muted);
  color: var(--text-primary);
}
.scope-select-pill.selected {
  background: var(--accent-bg);
  border-color: var(--accent-border);
  color: var(--text-accent);
}

/* ── BOARD ── */
.board-container {
  display: flex;
  height: calc(100vh - 52px - 37px);
  overflow-x: auto;
  overflow-y: hidden;
}

.column {
  flex: 0 0 280px;
  min-width: 280px;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  height: 100%;
}
.column-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
  position: relative;
}
.column-title {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.01em;
}
.column-count {
  font-size: 11px;
  color: var(--text-muted);
  background: var(--bg-overlay);
  padding: 1px 6px;
  border: 1px solid var(--border);
}
.column-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}
.column-body::-webkit-scrollbar { width: 4px; }
.column-body::-webkit-scrollbar-track { background: transparent; }
.column-body::-webkit-scrollbar-thumb { background: var(--border); }

/* ── CARDS ── */
.card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--border);
  padding: 14px 16px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
  position: relative;
}
.card:hover {
  border-top-color: var(--border-light);
  border-right-color: var(--border-light);
  border-bottom-color: var(--border-light);
  background: var(--bg-overlay);
}
.card.dragging {
  opacity: 0.4;
}
.card-title {
  font-family: var(--font-ui);
  font-size: 13.5px;
  font-weight: 500;
  margin-bottom: 6px;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.card-meta {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
}
.scope-pill {
  font-family: var(--font-mono);
  font-size: 11px;
  letter-spacing: 0.02em;
  padding: 1px 6px;
  background: var(--bg-active);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.assignee-badge {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 1px 6px;
  background: var(--accent-bg);
  color: var(--text-accent);
  border: 1px solid var(--accent-border);
  margin-left: auto;
}
.due-badge {
  font-size: 10px;
  color: var(--text-muted);
}
.due-badge.overdue {
  color: var(--danger);
}
.checkbox-progress {
  font-size: 10px;
  color: var(--text-muted);
}
.comment-count {
  font-size: 10px;
  color: var(--text-muted);
}

/* Column drop target */
.column-body.drag-over {
  background: var(--accent-drag);
}
.column-body.drag-over::after {
  content: '';
  display: block;
  height: 3px;
  background: var(--text-accent);
  opacity: 0.4;
  margin: 4px 0;
}

/* ── ADD TASK BUTTON ── */
.add-task-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: 1px dashed var(--border);
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 12px;
  cursor: pointer;
  margin-top: 4px;
}
.add-task-btn:hover {
  border-color: var(--text-secondary);
  color: var(--text-secondary);
}

/* ── CREATE TASK MODAL ── */
.create-backdrop {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--backdrop);
  z-index: 1100;
  backdrop-filter: blur(4px);
}
.create-backdrop.open { display: flex; align-items: center; justify-content: center; }
.create-modal {
  width: 90vw;
  max-width: 860px;
  max-height: 88vh;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}
.create-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.create-modal-header span {
  font-size: 14px;
  font-weight: 600;
}
.create-modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.create-modal-body::-webkit-scrollbar { width: 6px; }
.create-modal-body::-webkit-scrollbar-track { background: transparent; }
.create-modal-body::-webkit-scrollbar-thumb { background: var(--border); }
.create-field label {
  display: block;
  color: var(--text-muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 4px;
}
.create-field input,
.create-field select {
  width: 100%;
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-ui);
  font-size: 13px;
  padding: 8px 10px;
  outline: none;
}
.create-field textarea {
  width: 100%;
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 13px;
  padding: 8px 10px;
  outline: none;
}
.create-textarea {
  flex: 1;
  min-width: 0;
  resize: none;
}
.create-field input:focus,
.create-field textarea:focus,
.create-field select:focus {
  border-color: var(--text-accent);
}
.create-field textarea {
  min-height: 200px;
  resize: vertical;
  line-height: 1.6;
}
.create-row {
  display: flex;
  gap: 12px;
}
.create-row > * { flex: 1; }
.create-modal-footer {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
.btn {
  padding: 5px 12px;
  border: 1px solid var(--border);
  background: var(--bg-overlay);
  color: var(--text-primary);
  font-family: var(--font-ui);
  font-size: 12px;
  cursor: pointer;
}
.btn:hover { background: var(--bg-hover); }
.btn-primary {
  background: var(--accent-bg-strong);
  border-color: var(--accent-border-strong);
  color: var(--text-accent);
}
.btn-primary:hover {
  background: var(--accent-bg-hover);
}
.btn-danger {
  background: var(--danger-bg);
  border-color: var(--danger-border);
  color: var(--danger);
}
.btn-danger:hover {
  background: var(--danger-bg-hover);
}

/* ── MODAL ── */
.modal-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--backdrop);
  z-index: 1000;
  backdrop-filter: blur(4px);
}
.modal-backdrop.open { display: flex; align-items: center; justify-content: center; }

.modal {
  width: 92vw;
  height: 90vh;
  max-width: 1200px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: relative;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.modal-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
  flex: 1;
}
.modal-title {
  font-size: 16px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.modal-column-badge {
  font-size: 11px;
  color: var(--text-muted);
  padding: 2px 8px;
  border: 1px solid var(--border);
  background: var(--bg-overlay);
  white-space: nowrap;
}
.modal-close {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-size: 14px;
  cursor: pointer;
  font-family: var(--font-ui);
  padding: 4px 10px;
  flex-shrink: 0;
}
.modal-close:hover { color: var(--text-primary); border-color: var(--border-light); }
.modal-actions {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

.modal-content {
  flex: 1;
  display: flex;
  min-height: 0;
  overflow: hidden;
}

.modal-main {
  flex: 1;
  overflow-y: auto;
  padding: 24px 32px;
  min-width: 0;
}
.modal-main::-webkit-scrollbar { width: 6px; }
.modal-main::-webkit-scrollbar-track { background: transparent; }
.modal-main::-webkit-scrollbar-thumb { background: var(--border); }

.modal-sidebar {
  width: 260px;
  flex-shrink: 0;
  border-left: 1px solid var(--border);
  padding: 20px;
  overflow-y: auto;
  background: var(--bg-base);
}
.modal-sidebar::-webkit-scrollbar { width: 4px; }
.modal-sidebar::-webkit-scrollbar-track { background: transparent; }
.modal-sidebar::-webkit-scrollbar-thumb { background: var(--border); }

.sidebar-section {
  margin-bottom: 16px;
}
.sidebar-label {
  color: var(--text-muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 4px;
}
.sidebar-value {
  color: var(--text-secondary);
  font-size: 12px;
}
.sidebar-value .scope-pill { margin-right: 4px; margin-bottom: 2px; display: inline-block; }

/* ── Rendered markdown ── */
.rendered h1 {
  font-size: 18px;
  font-weight: 700;
  margin: 24px 0 10px 0;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border);
  padding-bottom: 8px;
}
.rendered h2 {
  font-size: 15px;
  font-weight: 600;
  margin: 22px 0 8px 0;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border);
  padding-bottom: 6px;
}
.rendered h3 {
  font-size: 14px;
  font-weight: 600;
  margin: 18px 0 6px 0;
  color: var(--text-primary);
}
.rendered h4 {
  font-size: 13px;
  font-weight: 600;
  margin: 14px 0 4px 0;
  color: var(--text-secondary);
}
.rendered p {
  margin: 8px 0;
  color: var(--text-secondary);
  line-height: 1.7;
}
.rendered ul, .rendered ol {
  margin: 8px 0;
  padding-left: 22px;
  color: var(--text-secondary);
}
.rendered li {
  margin: 4px 0;
  line-height: 1.6;
}
.rendered code {
  background: var(--bg-overlay);
  padding: 2px 6px;
  font-family: var(--font-mono);
  font-size: 12px;
  border: 1px solid var(--border);
  border-radius: 2px;
}
.rendered pre {
  background: var(--bg-base);
  padding: 16px;
  overflow-x: auto;
  margin: 12px 0;
  border: 1px solid var(--border);
  line-height: 1.6;
  font-size: 12px;
}
.rendered pre code {
  background: none;
  border: none;
  padding: 0;
  border-radius: 0;
}
.rendered strong { color: var(--text-primary); }
.rendered em { font-style: italic; }
.rendered a { color: var(--text-accent); }
.rendered blockquote {
  border-left: 3px solid var(--border-light);
  padding: 4px 16px;
  margin: 10px 0;
  color: var(--text-muted);
}
.rendered hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 16px 0;
}
.rendered table {
  border-collapse: collapse;
  margin: 10px 0;
  width: 100%;
}
.rendered th, .rendered td {
  border: 1px solid var(--border);
  padding: 6px 10px;
  font-size: 12px;
  text-align: left;
}
.rendered th {
  background: var(--bg-overlay);
  color: var(--text-primary);
  font-weight: 600;
}
.rendered td {
  color: var(--text-secondary);
}

.code-block-wrapper {
  position: relative;
  margin: 12px 0;
}
.code-lang-label {
  position: absolute;
  top: 0;
  right: 0;
  font-size: 10px;
  color: var(--text-muted);
  padding: 4px 10px;
  background: var(--bg-overlay);
  border-left: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}

.rendered .task-checkbox {
  appearance: none;
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border: 1px solid var(--border-light);
  background: var(--bg-overlay);
  cursor: pointer;
  vertical-align: middle;
  margin-right: 6px;
  position: relative;
}
.rendered .task-checkbox:checked {
  background: var(--accent-bg);
  border-color: var(--text-accent);
}
.rendered .task-checkbox:checked::after {
  content: '\2713';
  position: absolute;
  top: -1px;
  left: 2px;
  font-size: 11px;
  color: var(--text-accent);
}

/* Edit mode */
.edit-textarea {
  width: 100%;
  min-height: 500px;
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 16px;
  resize: vertical;
  outline: none;
  line-height: 1.6;
}
.edit-textarea:focus {
  border-color: var(--text-accent);
}

/* ── EDITOR SPLIT PREVIEW ── */
.editor-split {
  display: flex;
  gap: 12px;
  min-height: 0;
}
.editor-split .edit-textarea,
.editor-split .create-textarea {
  flex: 1;
  min-width: 0;
}
.editor-preview {
  flex: 1;
  min-width: 0;
  background: var(--bg-base);
  border: 1px solid var(--border);
  padding: 16px;
  overflow-y: auto;
  font-size: 13px;
  line-height: 1.6;
}
.editor-preview-label {
  font-family: var(--font-ui);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin-bottom: 4px;
}

/* ── COMMENTS ── */
.comments-section {
  border-top: 1px solid var(--border);
  margin-top: 28px;
  padding-top: 20px;
}
.comments-header {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.comment {
  border: 1px solid var(--border);
  background: var(--bg-base);
  margin-bottom: 10px;
  padding: 12px 16px;
}
.comment-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.comment-author {
  font-weight: 600;
  font-size: 12px;
  color: var(--text-accent);
}
.comment-date {
  font-size: 11px;
  color: var(--text-muted);
}
.comment-delete {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-family: var(--font-ui);
  font-size: 11px;
  padding: 0 4px;
}
.comment-delete:hover { color: var(--danger); }

.comment-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 12px;
}
.comment-form-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
.comment-input {
  width: 100%;
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 10px 12px;
  outline: none;
  resize: vertical;
  min-height: 80px;
  line-height: 1.5;
}
.comment-input:focus { border-color: var(--text-accent); }
.comment-author-input {
  background: var(--bg-base);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-ui);
  font-size: 12px;
  padding: 6px 10px;
  outline: none;
  width: 180px;
}
.comment-author-input:focus { border-color: var(--text-accent); }

/* ── RESOURCE VIEWS (prompts/documents) ── */
.resource-view {
  display: none;
  flex-direction: column;
  height: calc(100vh - 52px);
  overflow: hidden;
}
.resource-view.active {
  display: flex;
}
.resource-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
  flex-shrink: 0;
}
.resource-toolbar-left {
  display: flex;
  align-items: center;
  gap: 8px;
}
.resource-toolbar-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.resource-count {
  font-size: 11px;
  color: var(--text-muted);
  background: var(--bg-overlay);
  padding: 1px 6px;
  border: 1px solid var(--border);
}
.resource-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
}
.resource-list::-webkit-scrollbar { width: 6px; }
.resource-list::-webkit-scrollbar-track { background: transparent; }
.resource-list::-webkit-scrollbar-thumb { background: var(--border); }
.resource-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  padding: 16px 20px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.resource-card:hover {
  border-color: var(--border-light);
  background: var(--bg-overlay);
}
.resource-card-left {
  min-width: 0;
  flex: 1;
}
.resource-card-title {
  font-family: var(--font-ui);
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.resource-card-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.resource-card-date {
  font-size: 11px;
  color: var(--text-muted);
}
.resource-card-rev {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  background: var(--bg-overlay);
  padding: 1px 6px;
  border: 1px solid var(--border);
}

/* ── RESOURCE MODAL ── */
.resource-modal-revisions {
  border-top: 1px solid var(--border);
  margin-top: 24px;
  padding-top: 16px;
}
.revisions-header {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  margin-bottom: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}
.revisions-header::before {
  content: '\25B6';
  font-size: 8px;
  transition: transform 0.15s;
}
.revisions-header.expanded::before {
  transform: rotate(90deg);
}
.revisions-list {
  display: none;
}
.revisions-list.expanded {
  display: block;
}
.revision-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  border: 1px solid var(--border);
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 12px;
  color: var(--text-secondary);
  transition: background 0.15s;
}
.revision-item:hover {
  background: var(--bg-overlay);
}
.revision-item.active {
  border-color: var(--text-accent);
  background: var(--accent-subtle);
}
.revision-label {
  font-weight: 500;
}
.revision-date {
  font-size: 11px;
  color: var(--text-muted);
}

/* ── DIFF VIEW ── */
.diff-view {
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.6;
  background: var(--bg-base);
  border: 1px solid var(--border);
  padding: 16px;
  overflow-x: auto;
  white-space: pre-wrap;
  word-break: break-word;
}
.diff-line-add {
  background: var(--diff-add-bg);
  color: var(--diff-add-color);
}
.diff-line-del {
  background: var(--diff-del-bg);
  color: var(--diff-del-color);
}
.diff-line-ctx {
  color: var(--text-muted);
}
.diff-toggle {
  display: inline-flex;
  gap: 0;
  margin-left: 12px;
}
.diff-toggle button {
  padding: 2px 10px;
  background: var(--bg-overlay);
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 11px;
  cursor: pointer;
}
.diff-toggle button:first-child {
  border-right: none;
}
.diff-toggle button.active {
  background: var(--bg-active);
  color: var(--text-primary);
}

/* ── ACTIVITY FEED ── */
.activity-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
}
.activity-type {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 2px 8px;
  border: 1px solid var(--border);
  white-space: nowrap;
  min-width: 70px;
  text-align: center;
}
.activity-title {
  flex: 1;
  font-size: 13px;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
  color: var(--text-primary);
}
.activity-title:hover {
  color: var(--text-accent);
}
.activity-time {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  white-space: nowrap;
}

/* ── EMPTY STATE ── */
.empty-state {
  color: var(--text-muted);
  font-size: 13px;
  text-align: center;
  padding: 20px 10px;
}

/* ── THEME TOGGLE ── */
.theme-toggle {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-size: 14px;
  cursor: pointer;
  padding: 3px 8px;
  line-height: 1;
  transition: color 0.15s, border-color 0.15s;
}
.theme-toggle:hover {
  color: var(--text-primary);
  border-color: var(--border-light);
}

/* ── RESPONSIVE ── */
@media (max-width: 768px) {
  .board-container {
    flex-direction: column;
    overflow-x: hidden;
    overflow-y: auto;
  }
  .column {
    flex: none;
    min-width: 100%;
    width: 100%;
    border-right: none;
    border-bottom: 1px solid var(--border);
    max-height: none;
    height: auto;
  }
  .column-body {
    overflow-y: visible;
    min-height: 60px;
  }
  .modal {
    width: 100vw;
    height: 100vh;
  }
  .modal-sidebar {
    display: none;
  }
  .filter-bar {
    flex-wrap: wrap;
  }
  .header-tabs {
    gap: 0;
  }
  .header-tab {
    padding: 5px 8px;
    font-size: 11px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo"><span id="project-name">mdboard</span><span>/</span><span class="version" id="app-version"></span></div>
    <div class="header-tabs">
      <button class="header-tab active" data-view="board" onclick="switchView('board')">Board</button>
      <button class="header-tab" data-view="prompts" onclick="switchView('prompts')">Prompts</button>
      <button class="header-tab" data-view="documents" onclick="switchView('documents')">Documents</button>
      <button class="header-tab" data-view="activity" onclick="switchView('activity')">Activity</button>
    </div>
  </div>
  <div class="header-right">
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle theme (T)">&#9790;</button>
    <span class="kbd" style="margin-left:8px;">N</span> <span style="color:var(--text-muted);font-size:11px;">new</span>
    <span class="kbd" style="margin-left:8px;">Esc</span> <span style="color:var(--text-muted);font-size:11px;">close</span>
  </div>
</div>

<div id="board-view">
  <div class="filter-bar" style="gap:12px;">
    <div class="scope-badge-bar" id="scope-badge-bar"></div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <div class="filter-group">
        <label>assignee</label>
        <input type="text" id="filter-assignee" placeholder="filter..." style="width:100px;">
      </div>
      <button class="filter-clear" onclick="clearFilters()">clear</button>
    </div>
  </div>
  <div class="board-container" id="board"></div>
</div>

<div id="prompts-view" class="resource-view">
  <div class="resource-toolbar">
    <div class="resource-toolbar-left">
      <span class="resource-toolbar-title">Prompts</span>
      <span class="resource-count" id="prompts-count">0</span>
    </div>
    <button class="btn btn-primary" onclick="openCreateResource('prompts')">+ new prompt</button>
  </div>
  <div class="resource-list" id="prompts-list"></div>
</div>

<div id="documents-view" class="resource-view">
  <div class="resource-toolbar">
    <div class="resource-toolbar-left">
      <span class="resource-toolbar-title">Documents</span>
      <span class="resource-count" id="documents-count">0</span>
    </div>
    <button class="btn btn-primary" onclick="openCreateResource('documents')">+ new document</button>
  </div>
  <div class="resource-list" id="documents-list"></div>
</div>

<div id="activity-view" class="resource-view">
  <div class="resource-toolbar">
    <div class="resource-toolbar-left">
      <span class="resource-toolbar-title">Activity</span>
    </div>
  </div>
  <div class="resource-list" id="activity-list"></div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal" id="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-left">
        <span class="modal-column-badge" id="modal-column-badge"></span>
        <span class="modal-title" id="modal-title"></span>
      </div>
      <div class="modal-actions">
        <button class="btn" id="modal-edit-btn" onclick="toggleEditMode()">edit</button>
        <button class="btn btn-danger" id="modal-delete-btn" onclick="deleteCurrentTask()">delete</button>
        <button class="modal-close" onclick="closeModal()">Esc</button>
      </div>
    </div>
    <div class="modal-content">
      <div class="modal-main" id="modal-main"></div>
      <div class="modal-sidebar" id="modal-sidebar"></div>
    </div>
  </div>
</div>

<!-- Create Task Modal -->
<div class="create-backdrop" id="create-backdrop">
  <div class="create-modal" onclick="event.stopPropagation()">
    <div class="create-modal-header">
      <span>New Task</span>
      <button class="modal-close" onclick="closeCreateModal()">Esc</button>
    </div>
    <div class="create-modal-body">
      <div class="create-field">
        <label>Title</label>
        <input type="text" id="create-title" placeholder="task title">
      </div>
      <div class="create-row">
        <div class="create-field">
          <label>Column</label>
          <select id="create-column"></select>
        </div>
        <div class="create-field">
          <label>Assignee</label>
          <input type="text" id="create-assignee" placeholder="assignee">
        </div>
        <div class="create-field">
          <label>Scopes</label>
          <input type="text" id="create-scopes" placeholder="comma separated or click below">
          <div class="scope-select-bar" id="create-scope-picker"></div>
        </div>
      </div>
      <div class="create-field" style="flex:1;display:flex;flex-direction:column;min-height:0;">
        <label>Description (markdown)</label>
        <div class="editor-split" style="flex:1;min-height:340px;">
          <textarea id="create-desc" class="create-textarea" style="min-height:100%;" placeholder="paste or type markdown content..." oninput="updatePreview('create-desc','create-desc-preview')"></textarea>
          <div>
            <div class="editor-preview-label">preview</div>
            <div class="editor-preview rendered" id="create-desc-preview"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="create-modal-footer">
      <button class="btn" onclick="closeCreateModal()">cancel</button>
      <button class="btn btn-primary" onclick="submitCreateModal()">create</button>
    </div>
  </div>
</div>

<!-- Resource Create Modal -->
<div class="create-backdrop" id="resource-create-backdrop">
  <div class="create-modal" onclick="event.stopPropagation()">
    <div class="create-modal-header">
      <span id="resource-create-title">New Prompt</span>
      <button class="modal-close" onclick="closeResourceCreate()">Esc</button>
    </div>
    <div class="create-modal-body">
      <div class="create-field">
        <label>Title</label>
        <input type="text" id="resource-create-name" placeholder="title">
      </div>
      <div class="create-field">
        <label>Scopes</label>
        <input type="text" id="resource-create-scopes" placeholder="comma separated or click below">
        <div class="scope-select-bar" id="resource-create-scope-picker"></div>
      </div>
      <div class="create-field" style="flex:1;display:flex;flex-direction:column;min-height:0;">
        <label>Content (markdown)</label>
        <div class="editor-split" style="flex:1;min-height:340px;">
          <textarea id="resource-create-body" class="create-textarea" style="min-height:100%;" placeholder="paste or type content..." oninput="updatePreview('resource-create-body','resource-create-preview')"></textarea>
          <div>
            <div class="editor-preview-label">preview</div>
            <div class="editor-preview rendered" id="resource-create-preview"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="create-modal-footer">
      <button class="btn" onclick="closeResourceCreate()">cancel</button>
      <button class="btn btn-primary" onclick="submitResourceCreate()">create</button>
    </div>
  </div>
</div>

<!-- Resource Detail Modal -->
<div class="modal-backdrop" id="resource-modal-backdrop">
  <div class="modal" id="resource-modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-left">
        <span class="modal-column-badge" id="resource-modal-type-badge"></span>
        <span class="modal-title" id="resource-modal-title"></span>
      </div>
      <div class="modal-actions">
        <button class="btn" id="resource-modal-edit-btn" onclick="toggleResourceEdit()">edit</button>
        <button class="btn btn-danger" id="resource-modal-delete-btn" onclick="deleteCurrentResource()">delete</button>
        <button class="modal-close" onclick="closeResourceModal()">Esc</button>
      </div>
    </div>
    <div class="modal-content">
      <div class="modal-main" id="resource-modal-main"></div>
      <div class="modal-sidebar" id="resource-modal-sidebar"></div>
    </div>
  </div>
</div>

<script>
// ── THEME ──
function getTheme() {
  return document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
}

function setTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
  localStorage.setItem('mdboard-theme', theme);
  updateThemeToggle();
}

function toggleTheme() {
  setTheme(getTheme() === 'dark' ? 'light' : 'dark');
}

function updateThemeToggle() {
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.innerHTML = getTheme() === 'dark' ? '&#9790;' : '&#9728;';
}
updateThemeToggle();

// ── STATE ──
let boardData = null;
let currentTask = null;
let editMode = false;
let commentCounts = {};
let currentView = 'board';
let resourceData = { prompts: [], documents: [] };
let currentResource = null;
let currentResourceType = null;
let resourceEditMode = false;
let viewingRevision = null;
let showRevisionDiff = false;

// ── API ──
async function api(path, opts = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || res.statusText);
  }
  return res.json();
}

// ── LOAD BOARD ──
async function loadBoard() {
  boardData = await api('/api/board');
  await loadScopes();
  // Preload comment counts
  const allTasks = boardData.columns.flatMap(c => c.tasks);
  const counts = await Promise.all(
    allTasks.map(async t => {
      const id = t.meta.id;
      if (id == null) return [null, 0];
      try {
        const comments = await api(`/api/comments/${id}`);
        return [id, comments.length];
      } catch { return [id, 0]; }
    })
  );
  commentCounts = {};
  counts.forEach(([id, n]) => { if (id != null) commentCounts[id] = n; });
  renderBoard();
}

// ── FILTERS ──
let activeScopes = new Set();
let knownScopes = [];

function getFilters() {
  return {
    assignee: document.getElementById('filter-assignee').value.toLowerCase().trim(),
  };
}

function matchesFilter(task) {
  const f = getFilters();
  const m = task.meta;
  if (f.assignee && !(m.assignee || '').toLowerCase().includes(f.assignee)) return false;
  if (activeScopes.size > 0) {
    const scopes = (m.scopes || []).map(s => s.toLowerCase());
    if (!scopes.some(s => activeScopes.has(s))) return false;
  }
  return true;
}

function clearFilters() {
  document.getElementById('filter-assignee').value = '';
  activeScopes.clear();
  renderBoard();
}

function toggleScope(scope) {
  const lower = scope.toLowerCase();
  if (activeScopes.has(lower)) {
    activeScopes.delete(lower);
  } else {
    activeScopes.add(lower);
  }
  renderBoard();
}

async function loadScopes() {
  try {
    knownScopes = await api('/api/scopes');
  } catch { knownScopes = []; }
}

function renderScopeBadges() {
  const bar = document.getElementById('scope-badge-bar');
  if (!bar) return;
  // Merge server-defined scopes with any in-use scopes from tasks
  const allScopes = new Set(knownScopes.map(s => s));
  if (boardData) {
    boardData.columns.forEach(col => {
      col.tasks.forEach(task => {
        (task.meta.scopes || []).forEach(s => allScopes.add(s));
      });
    });
  }
  if (allScopes.size === 0) {
    bar.innerHTML = '';
    return;
  }
  bar.innerHTML = Array.from(allScopes).sort().map(s => {
    const isActive = activeScopes.has(s.toLowerCase());
    return `<button class="scope-badge${isActive ? ' active' : ''}" onclick="toggleScope('${escAttr(s)}')">${escHtml(s)}</button>`;
  }).join('');
}

document.getElementById('filter-assignee').addEventListener('input', renderBoard);

// ── CHECKBOX PROGRESS ──
function checkboxProgress(body) {
  const total = (body.match(/- \[[ x]\]/g) || []).length;
  if (total === 0) return null;
  const checked = (body.match(/- \[x\]/gi) || []).length;
  return { checked, total };
}

// ── DUE DATE ──
function isDueOverdue(due) {
  if (!due) return false;
  const d = new Date(due);
  const today = new Date();
  today.setHours(0,0,0,0);
  return d < today;
}

// ── RENDER BOARD ──
function renderBoard() {
  if (!boardData) return;
  renderScopeBadges();
  const board = document.getElementById('board');
  board.innerHTML = '';

  boardData.columns.forEach(col => {
    const filteredTasks = col.tasks.filter(matchesFilter);
    const colEl = document.createElement('div');
    colEl.className = 'column';
    colEl.innerHTML = `
      <div class="column-header" style="border-top: 3px solid ${col.color}">
        <span class="column-title" style="color:${col.color}">${escHtml(col.label)}</span>
        <span class="column-count">${filteredTasks.length}</span>
      </div>
      <div class="column-body" data-column="${col.name}">
        ${filteredTasks.length === 0 ? '<div class="empty-state">&mdash;</div>' : ''}
      </div>
    `;

    const body = colEl.querySelector('.column-body');

    filteredTasks.forEach(task => {
      const card = createCard(task, col.color);
      body.appendChild(card);
    });

    const addBtn = document.createElement('button');
    addBtn.className = 'add-task-btn';
    addBtn.innerHTML = '+ new task';
    addBtn.onclick = () => openCreateModal(col.name);
    body.appendChild(addBtn);

    // Drag-and-drop
    body.addEventListener('dragover', e => {
      e.preventDefault();
      body.classList.add('drag-over');
    });
    body.addEventListener('dragleave', () => {
      body.classList.remove('drag-over');
    });
    body.addEventListener('drop', async e => {
      e.preventDefault();
      body.classList.remove('drag-over');
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      if (data.from_column === col.name) return;
      await api('/api/task/move', {
        method: 'PATCH',
        body: JSON.stringify({
          filename: data.filename,
          from_column: data.from_column,
          to_column: col.name,
        }),
      });
      if (currentTask && currentTask.filename === data.filename) {
        currentTask.column = col.name;
      }
      loadBoard();
    });

    board.appendChild(colEl);
  });
}

function createCard(task, colColor) {
  const m = task.meta;
  const card = document.createElement('div');
  card.className = 'card';
  card.draggable = true;
  if (colColor) card.style.borderLeftColor = colColor;

  let html = `<div class="card-title">${escHtml(m.title || task.filename)}</div>`;
  html += `<div class="card-meta">`;

  const scopes = m.scopes || [];
  scopes.forEach(s => {
    html += `<span class="scope-pill">${escHtml(s)}</span>`;
  });

  const prog = checkboxProgress(task.body || '');
  if (prog) {
    html += `<span class="checkbox-progress">${prog.checked}/${prog.total}</span>`;
  }

  if (m.due) {
    const overdue = isDueOverdue(m.due);
    html += `<span class="due-badge${overdue ? ' overdue' : ''}">${m.due}</span>`;
  }

  const cc = commentCounts[m.id];
  if (cc > 0) {
    html += `<span class="comment-count">${cc} comment${cc !== 1 ? 's' : ''}</span>`;
  }

  if (m.assignee) {
    html += `<span class="assignee-badge">${escHtml(m.assignee)}</span>`;
  }

  html += `</div>`;
  card.innerHTML = html;

  card.addEventListener('click', e => {
    if (e.defaultPrevented) return;
    openModal(task);
  });

  card.addEventListener('dragstart', e => {
    card.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify({
      filename: task.filename,
      from_column: task.column,
    }));
    e.dataTransfer.effectAllowed = 'move';
  });
  card.addEventListener('dragend', () => {
    card.classList.remove('dragging');
  });

  return card;
}

// ── MODAL ──
function openModal(task) {
  currentTask = task;
  editMode = false;
  renderModal();
  document.getElementById('modal-backdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modal-backdrop').classList.remove('open');
  document.body.style.overflow = '';
  currentTask = null;
  editMode = false;
}

async function renderModal() {
  if (!currentTask) return;
  const m = currentTask.meta;
  const body = currentTask.body || '';

  document.getElementById('modal-title').textContent = m.title || currentTask.filename;
  document.getElementById('modal-column-badge').textContent = currentTask.column;
  document.getElementById('modal-edit-btn').textContent = editMode ? 'view' : 'edit';

  // Sidebar
  const sidebar = document.getElementById('modal-sidebar');
  let sideHtml = '';
  sideHtml += sidebarField('ID', m.id);
  sideHtml += sidebarField('Assignee', m.assignee || '<span style="color:var(--text-muted)">unassigned</span>');
  sideHtml += sidebarField('Scopes', (m.scopes || []).map(s => `<span class="scope-pill">${escHtml(s)}</span>`).join(' ') || '<span style="color:var(--text-muted)">none</span>');
  sideHtml += sidebarField('Created', m.created || '');
  if (m.due) sideHtml += sidebarField('Due', `<span style="${isDueOverdue(m.due) ? 'color:var(--danger)' : ''}">${m.due}</span>`);
  if (m.branch) sideHtml += sidebarField('Branch', `<span style="color:var(--text-accent)">${escHtml(m.branch)}</span>`);
  if (m.completed) sideHtml += sidebarField('Completed', m.completed);
  sideHtml += sidebarField('File', `<span style="color:var(--text-muted);font-size:11px;">${escHtml(currentTask.filename)}</span>`);
  if (m.related && m.related.length) {
    sideHtml += sidebarField('Related', renderRelatedLinks(m.related));
  }
  sidebar.innerHTML = sideHtml;

  // Main content
  const main = document.getElementById('modal-main');

  if (editMode) {
    const raw = buildRawContent(currentTask);
    main.innerHTML = `
      <div class="editor-split" style="min-height:500px;">
        <textarea class="edit-textarea" id="edit-raw" oninput="updateEditPreview()">${escHtml(raw)}</textarea>
        <div style="display:flex;flex-direction:column;flex:1;min-width:0;">
          <div class="editor-preview-label">preview</div>
          <div class="editor-preview rendered" id="edit-preview" style="flex:1;"></div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:6px;justify-content:flex-end;">
        <button class="btn" onclick="toggleEditMode()">cancel</button>
        <button class="btn btn-primary" onclick="saveEdit()">save</button>
      </div>
    `;
    updateEditPreview();
    return;
  }

  // View mode
  let html = `<div class="rendered">${renderMarkdown(body)}</div>`;

  // Comments
  html += `<div class="comments-section" id="comments-section">`;
  html += `<div class="comments-header">Comments</div>`;
  html += `<div id="comments-list"><span style="color:var(--text-muted);font-size:11px;">loading...</span></div>`;
  html += `<div class="comment-form">`;
  html += `<div class="comment-form-row">`;
  html += `<input type="text" class="comment-author-input" id="comment-author" placeholder="your name" value="${escHtml(localStorage.getItem('comment-author') || '')}">`;
  html += `</div>`;
  html += `<textarea class="comment-input" id="comment-body" placeholder="write a comment... (markdown supported)"></textarea>`;
  html += `<div style="display:flex;justify-content:flex-end;">`;
  html += `<button class="btn btn-primary" onclick="submitComment()">comment</button>`;
  html += `</div>`;
  html += `</div>`;
  html += `</div>`;

  main.innerHTML = html;
  loadComments();
}

function sidebarField(label, value) {
  return `<div class="sidebar-section"><div class="sidebar-label">${label}</div><div class="sidebar-value">${value}</div></div>`;
}

function toggleEditMode() {
  editMode = !editMode;
  renderModal();
}

async function saveEdit() {
  if (!currentTask) return;
  const raw = document.getElementById('edit-raw').value;
  await api(`/api/task/${currentTask.column}/${currentTask.filename}`, {
    method: 'PUT',
    body: JSON.stringify({ content: raw }),
  });
  const updated = await api(`/api/task/${currentTask.column}/${currentTask.filename}`);
  currentTask = updated;
  editMode = false;
  renderModal();
  loadBoard();
}

async function deleteCurrentTask() {
  if (!currentTask) return;
  if (!confirm(`Delete "${currentTask.meta.title}"?`)) return;
  await api(`/api/task/${currentTask.column}/${currentTask.filename}`, {
    method: 'DELETE',
  });
  closeModal();
  loadBoard();
}

// ── COMMENTS ──
async function loadComments() {
  if (!currentTask || currentTask.meta.id == null) return;
  const taskId = currentTask.meta.id;
  try {
    const comments = await api(`/api/comments/${taskId}`);
    const container = document.getElementById('comments-list');
    if (!container) return;
    if (comments.length === 0) {
      container.innerHTML = '<div style="color:var(--text-muted);font-size:11px;padding:8px 0;">no comments yet</div>';
      return;
    }
    container.innerHTML = comments.map(c => {
      const author = c.meta.author || 'anonymous';
      const created = c.meta.created || '';
      return `
        <div class="comment">
          <div class="comment-meta">
            <span class="comment-author">${escHtml(author)}</span>
            <span>
              <span class="comment-date">${escHtml(created)}</span>
              <button class="comment-delete" onclick="deleteComment(${taskId}, '${escAttr(c.filename)}')" title="delete">x</button>
            </span>
          </div>
          <div class="rendered">${renderMarkdown(c.body || '')}</div>
        </div>
      `;
    }).join('');
  } catch {
    const container = document.getElementById('comments-list');
    if (container) container.innerHTML = '<div style="color:var(--text-muted);font-size:11px;">failed to load comments</div>';
  }
}

async function submitComment() {
  if (!currentTask || currentTask.meta.id == null) return;
  const bodyEl = document.getElementById('comment-body');
  const authorEl = document.getElementById('comment-author');
  const body = bodyEl.value.trim();
  if (!body) return;
  const author = authorEl.value.trim() || 'anonymous';

  localStorage.setItem('comment-author', author);

  await api(`/api/comments/${currentTask.meta.id}`, {
    method: 'POST',
    body: JSON.stringify({ author, body }),
  });

  bodyEl.value = '';
  loadComments();
  commentCounts[currentTask.meta.id] = (commentCounts[currentTask.meta.id] || 0) + 1;
  renderBoard();
}

async function deleteComment(taskId, filename) {
  if (!confirm('Delete this comment?')) return;
  await api(`/api/comments/${taskId}/${filename}`, { method: 'DELETE' });
  loadComments();
  commentCounts[taskId] = Math.max(0, (commentCounts[taskId] || 1) - 1);
  renderBoard();
}

function buildRawContent(task) {
  const m = task.meta;
  let lines = ['---'];
  const keys = ['id', 'title', 'priority', 'assignee', 'scopes', 'created', 'due', 'branch', 'completed'];
  const seen = new Set();
  keys.forEach(k => {
    if (m[k] !== undefined && m[k] !== null) {
      lines.push(`${k}: ${yamlVal(m[k])}`);
      seen.add(k);
    }
  });
  Object.keys(m).forEach(k => {
    if (!seen.has(k)) {
      lines.push(`${k}: ${yamlVal(m[k])}`);
    }
  });
  lines.push('---');
  lines.push('');
  lines.push(task.body || '');
  return lines.join('\n');
}

function yamlVal(v) {
  if (Array.isArray(v)) return '[' + v.join(', ') + ']';
  if (v === '' || v === null || v === undefined) return '""';
  return String(v);
}

// ── CREATE TASK MODAL ──
function renderScopePicker(pickerId, inputId) {
  const picker = document.getElementById(pickerId);
  if (!picker) return;
  const input = document.getElementById(inputId);
  const current = input.value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
  const allScopes = new Set(knownScopes);
  if (boardData) {
    boardData.columns.forEach(col => {
      col.tasks.forEach(task => {
        (task.meta.scopes || []).forEach(s => allScopes.add(s));
      });
    });
  }
  if (allScopes.size === 0) { picker.innerHTML = ''; return; }
  picker.innerHTML = Array.from(allScopes).sort().map(s => {
    const sel = current.includes(s.toLowerCase());
    return `<button type="button" class="scope-select-pill${sel ? ' selected' : ''}" onclick="toggleScopeInInput('${escAttr(s)}','${inputId}','${pickerId}')">${escHtml(s)}</button>`;
  }).join('');
}

function toggleScopeInInput(scope, inputId, pickerId) {
  const input = document.getElementById(inputId);
  let scopes = input.value.split(',').map(s => s.trim()).filter(Boolean);
  const lower = scope.toLowerCase();
  const idx = scopes.findIndex(s => s.toLowerCase() === lower);
  if (idx >= 0) {
    scopes.splice(idx, 1);
  } else {
    scopes.push(scope);
  }
  input.value = scopes.join(', ');
  renderScopePicker(pickerId, inputId);
}

function openCreateModal(colName) {
  const sel = document.getElementById('create-column');
  sel.innerHTML = '';
  if (boardData) {
    boardData.columns.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.label;
      if (c.name === colName) opt.selected = true;
      sel.appendChild(opt);
    });
  }
  document.getElementById('create-title').value = '';
  document.getElementById('create-assignee').value = '';
  document.getElementById('create-scopes').value = '';
  document.getElementById('create-desc').value = '';
  renderScopePicker('create-scope-picker', 'create-scopes');
  document.getElementById('create-backdrop').classList.add('open');
  document.getElementById('create-title').focus();
}

function closeCreateModal() {
  document.getElementById('create-backdrop').classList.remove('open');
}

async function submitCreateModal() {
  const title = document.getElementById('create-title').value.trim();
  if (!title) return;
  const column = document.getElementById('create-column').value;
  const assignee = document.getElementById('create-assignee').value.trim();
  const scopesRaw = document.getElementById('create-scopes').value.trim();
  const scopes = scopesRaw ? scopesRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
  const description = document.getElementById('create-desc').value;

  await api('/api/task', {
    method: 'POST',
    body: JSON.stringify({ column, title, description, assignee, scopes }),
  });
  closeCreateModal();
  loadBoard();
}

// ── MARKDOWN RENDERER ──
function renderMarkdown(md) {
  if (!md) return '';
  let html = md;

  // Code blocks with language labels
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    const label = lang ? `<span class="code-lang-label">${escHtml(lang)}</span>` : '';
    return `<div class="code-block-wrapper">${label}<pre><code>${escHtml(code.trimEnd())}</code></pre></div>`;
  });

  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

  // Headers
  html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Horizontal rule
  html = html.replace(/^---+$/gm, '<hr>');

  // Blockquotes
  html = html.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');

  // Checkboxes
  html = html.replace(/^- \[x\] (.+)$/gim, '<li><input type="checkbox" class="task-checkbox" checked disabled> $1</li>');
  html = html.replace(/^- \[ \] (.+)$/gm, '<li><input type="checkbox" class="task-checkbox" disabled> $1</li>');

  // Unordered list items
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');

  // Ordered list items
  html = html.replace(/^\d+\. (.+)$/gm, '<oli>$1</oli>');

  // Wrap consecutive <li> in <ul>, <oli> in <ol>
  html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, m => '<ul>' + m.trim() + '</ul>');
  html = html.replace(/((?:<oli>.*<\/oli>\n?)+)/g, m => '<ol>' + m.trim().replace(/<\/?oli>/g, s => s.replace('oli', 'li')) + '</ol>');

  // Bold / italic
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

  // Tables
  html = html.replace(/((?:^\|.+\|[ \t]*(?:\n|$))+)/gm, (block) => {
    const rows = block.trim().split('\n');
    if (rows.length < 2) return block;
    const parseRow = r => r.replace(/^\||\|$/g, '').split('|').map(c => c.trim());
    const headers = parseRow(rows[0]);
    // Check row 1 is a separator (dashes, colons, spaces, pipes)
    if (!/^\|[\s:|-]+\|$/.test(rows[1])) return block;
    const sepCells = parseRow(rows[1]);
    const aligns = sepCells.map(c => {
      if (/^:-+:$/.test(c)) return 'center';
      if (/^-+:$/.test(c)) return 'right';
      return 'left';
    });
    let t = '<table><thead><tr>';
    headers.forEach((h, i) => { t += `<th style="text-align:${aligns[i] || 'left'}">${h}</th>`; });
    t += '</tr></thead><tbody>';
    for (let r = 2; r < rows.length; r++) {
      const cells = parseRow(rows[r]);
      t += '<tr>';
      cells.forEach((c, i) => { t += `<td style="text-align:${aligns[i] || 'left'}">${c}</td>`; });
      t += '</tr>';
    }
    t += '</tbody></table>';
    return t;
  });

  // HTML comments
  html = html.replace(/<!--[\s\S]*?-->/g, '');

  // Paragraphs
  html = html.replace(/\n\n+/g, '</p><p>');
  html = html.replace(/^(?!<[huplobdr])/gm, '');

  return html;
}

function escHtml(s) {
  if (s == null) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escAttr(s) {
  return escHtml(s).replace(/'/g, '&#39;');
}

// ── KEYBOARD SHORTCUTS ──
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
    if (e.key === 'Escape') {
      e.target.blur();
      if (document.getElementById('create-backdrop').classList.contains('open')) {
        closeCreateModal();
      }
      if (document.getElementById('resource-create-backdrop').classList.contains('open')) {
        closeResourceCreate();
      }
    }
    return;
  }

  if (e.key === 'Escape') {
    if (document.getElementById('resource-create-backdrop').classList.contains('open')) {
      closeResourceCreate();
    } else if (document.getElementById('resource-modal-backdrop').classList.contains('open')) {
      closeResourceModal();
    } else if (document.getElementById('create-backdrop').classList.contains('open')) {
      closeCreateModal();
    } else {
      closeModal();
    }
  }

  if (e.key === 't' || e.key === 'T') {
    e.preventDefault();
    toggleTheme();
    return;
  }

  if (e.key === 'n' || e.key === 'N') {
    e.preventDefault();
    if (currentView === 'board') {
      if (boardData && boardData.columns.length > 0) {
        const defaultCol = boardData.columns[0].name;
        openCreateModal(defaultCol);
      }
    } else if (currentView === 'prompts' || currentView === 'documents') {
      openCreateResource(currentView);
    }
  }
});

// Close modals on backdrop click
document.getElementById('modal-backdrop').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});
document.getElementById('create-backdrop').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeCreateModal();
});

// ── VIEW SWITCHING ──
function switchView(name) {
  currentView = name;
  // Update tabs
  document.querySelectorAll('.header-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.view === name);
  });
  // Toggle views
  document.getElementById('board-view').style.display = name === 'board' ? '' : 'none';
  const promptsView = document.getElementById('prompts-view');
  const documentsView = document.getElementById('documents-view');
  const activityView = document.getElementById('activity-view');
  promptsView.classList.toggle('active', name === 'prompts');
  documentsView.classList.toggle('active', name === 'documents');
  activityView.classList.toggle('active', name === 'activity');
  // Update hash
  location.hash = name;
  // Load data
  if (name === 'prompts') loadResources('prompts');
  else if (name === 'documents') loadResources('documents');
  else if (name === 'activity') loadActivity();
}

// ── RESOURCE LIST ──
async function loadResources(type) {
  try {
    resourceData[type] = await api(`/api/${type}`);
  } catch { resourceData[type] = []; }
  renderResourceList(type);
}

function renderResourceList(type) {
  const list = document.getElementById(`${type}-list`);
  const count = document.getElementById(`${type}-count`);
  const items = resourceData[type] || [];
  count.textContent = items.length;

  if (items.length === 0) {
    list.innerHTML = `<div class="empty-state">&mdash;</div>`;
    return;
  }

  list.innerHTML = items.map(r => {
    const m = r.meta;
    const scopes = (m.scopes || []).map(s => `<span class="scope-pill">${escHtml(s)}</span>`).join('');
    return `
      <div class="resource-card" onclick="openResource('${type}', '${escAttr(r.dir_name)}')">
        <div class="resource-card-left">
          <div class="resource-card-title">${escHtml(m.title || r.dir_name)}</div>
          <div class="resource-card-meta">
            <span class="resource-card-date">${escHtml(m.updated || m.created || '')}</span>
            <span class="resource-card-rev">rev ${m.revision || 1}</span>
            ${scopes}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ── ACTIVITY FEED ──
async function loadActivity() {
  try {
    const entries = await api('/api/activity');
    renderActivity(entries);
  } catch {
    document.getElementById('activity-list').innerHTML = '<div class="empty-state">&mdash;</div>';
  }
}

function renderActivity(entries) {
  const list = document.getElementById('activity-list');
  if (!entries.length) {
    list.innerHTML = '<div class="empty-state">&mdash;</div>';
    return;
  }

  const typeColors = { task: 'var(--text-accent)', prompt: 'var(--color-prompt)', document: 'var(--color-document)' };

  list.innerHTML = entries.map(e => {
    const color = typeColors[e.type] || 'var(--text-muted)';
    const time = formatRelativeTime(e.mtime);
    const idStr = e.id != null ? String(e.id).padStart(3, '0') : '';
    const label = e.type + (idStr ? ':' + idStr : '');

    let onclick = '';
    if (e.type === 'task' && e.column && e.filename) {
      onclick = `onclick="openActivityTask('${escAttr(e.column)}','${escAttr(e.filename)}')"`;
    } else if (e.type === 'prompt' && e.dir_name) {
      onclick = `onclick="openResource('prompts','${escAttr(e.dir_name)}')"`;
    } else if (e.type === 'document' && e.dir_name) {
      onclick = `onclick="openResource('documents','${escAttr(e.dir_name)}')"`;
    }

    return `<div class="activity-item">
      <span class="activity-type" style="color:${color};border-color:${color};">${escHtml(label)}</span>
      <span class="activity-title" ${onclick}>${escHtml(e.title)}</span>
      <span class="activity-time">${escHtml(time)}</span>
    </div>`;
  }).join('');
}

async function openActivityTask(column, filename) {
  try {
    const task = await api(`/api/task/${column}/${filename}`);
    task.column = column;
    openModal(task);
  } catch {}
}

function formatRelativeTime(mtime) {
  const now = Date.now() / 1000;
  const diff = now - mtime;
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
  const d = new Date(mtime * 1000);
  return d.toISOString().slice(0, 10);
}

// ── RESOURCE CREATE ──
let createResourceType = null;

function openCreateResource(type) {
  createResourceType = type;
  const label = type === 'prompts' ? 'Prompt' : 'Document';
  document.getElementById('resource-create-title').textContent = `New ${label}`;
  document.getElementById('resource-create-name').value = '';
  document.getElementById('resource-create-scopes').value = '';
  document.getElementById('resource-create-body').value = '';
  renderScopePicker('resource-create-scope-picker', 'resource-create-scopes');
  document.getElementById('resource-create-backdrop').classList.add('open');
  document.getElementById('resource-create-name').focus();
}

function closeResourceCreate() {
  document.getElementById('resource-create-backdrop').classList.remove('open');
  createResourceType = null;
}

async function submitResourceCreate() {
  const title = document.getElementById('resource-create-name').value.trim();
  if (!title) return;
  const scopesRaw = document.getElementById('resource-create-scopes').value.trim();
  const scopes = scopesRaw ? scopesRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
  const body = document.getElementById('resource-create-body').value;

  await api(`/api/${createResourceType}`, {
    method: 'POST',
    body: JSON.stringify({ title, scopes, body }),
  });
  closeResourceCreate();
  loadResources(createResourceType);
}

document.getElementById('resource-create-backdrop').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeResourceCreate();
});

// ── RESOURCE DETAIL MODAL ──
async function openResource(type, dirName) {
  currentResourceType = type;
  resourceEditMode = false;
  viewingRevision = null;
  try {
    currentResource = await api(`/api/${type}/${dirName}`);
  } catch { return; }
  renderResourceModal();
  document.getElementById('resource-modal-backdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeResourceModal() {
  document.getElementById('resource-modal-backdrop').classList.remove('open');
  document.body.style.overflow = '';
  currentResource = null;
  currentResourceType = null;
  resourceEditMode = false;
  viewingRevision = null;
  showRevisionDiff = false;
}

async function renderResourceModal() {
  if (!currentResource) return;
  const m = currentResource.meta;
  const body = currentResource.body || '';
  const typeLabel = currentResourceType === 'prompts' ? 'prompt' : 'document';

  document.getElementById('resource-modal-title').textContent = m.title || currentResource.dir_name;
  document.getElementById('resource-modal-type-badge').textContent = typeLabel;
  document.getElementById('resource-modal-edit-btn').textContent = resourceEditMode ? 'view' : 'edit';

  // Sidebar
  const sidebar = document.getElementById('resource-modal-sidebar');
  let sideHtml = '';
  sideHtml += sidebarField('ID', m.id);
  sideHtml += sidebarField('Created', m.created || '');
  sideHtml += sidebarField('Updated', m.updated || m.created || '');
  sideHtml += sidebarField('Revision', m.revision || 1);
  sideHtml += sidebarField('Scopes', (m.scopes || []).map(s => `<span class="scope-pill">${escHtml(s)}</span>`).join(' ') || '<span style="color:var(--text-muted)">none</span>');
  sideHtml += sidebarField('Directory', `<span style="color:var(--text-muted);font-size:11px;">${escHtml(currentResource.dir_name)}</span>`);
  if (m.related && m.related.length) {
    sideHtml += sidebarField('Related', renderRelatedLinks(m.related));
  }
  sidebar.innerHTML = sideHtml;

  // Main content
  const main = document.getElementById('resource-modal-main');

  if (resourceEditMode) {
    main.innerHTML = `
      <div class="editor-split" style="min-height:500px;">
        <textarea class="edit-textarea" id="resource-edit-body" oninput="updateResourceEditPreview()">${escHtml(body)}</textarea>
        <div style="display:flex;flex-direction:column;flex:1;min-width:0;">
          <div class="editor-preview-label">preview</div>
          <div class="editor-preview rendered" id="resource-edit-preview" style="flex:1;"></div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:6px;justify-content:flex-end;">
        <button class="btn" onclick="toggleResourceEdit()">cancel</button>
        <button class="btn btn-primary" onclick="saveResourceEdit()">save</button>
      </div>
    `;
    updateResourceEditPreview();
    return;
  }

  // Determine what body to show (current or a specific revision)
  let displayBody = body;
  let revisionNote = '';
  if (viewingRevision) {
    displayBody = viewingRevision.body || '';
    revisionNote = `<div style="margin-bottom:12px;padding:8px 12px;border:1px solid var(--accent-border-strong);background:var(--accent-subtle);font-size:12px;color:var(--text-accent);display:flex;align-items:center;flex-wrap:wrap;">Viewing revision ${viewingRevision.meta.revision} &mdash; <a href="#" style="color:var(--text-accent);text-decoration:underline;margin-left:4px;" onclick="viewingRevision=null;showRevisionDiff=false;renderResourceModal();return false;">back to current</a><span class="diff-toggle" style="margin-left:auto;"><button class="${!showRevisionDiff ? 'active' : ''}" onclick="showRevisionDiff=false;renderResourceModal();">content</button><button class="${showRevisionDiff ? 'active' : ''}" onclick="showRevisionDiff=true;renderResourceModal();">diff</button></span></div>`;
  }

  let html = revisionNote;
  if (viewingRevision && showRevisionDiff) {
    html += `<div class="diff-view">${computeDiff(displayBody, body)}</div>`;
  } else {
    html += `<div class="rendered">${renderMarkdown(displayBody)}</div>`;
  }

  // Revisions panel
  html += `<div class="resource-modal-revisions">`;
  html += `<div class="revisions-header" onclick="toggleRevisions(this)">Revision History</div>`;
  html += `<div class="revisions-list" id="revisions-list"><span style="color:var(--text-muted);font-size:11px;">loading...</span></div>`;
  html += `</div>`;

  main.innerHTML = html;
  loadRevisions();
}

async function loadRevisions() {
  if (!currentResource || !currentResourceType) return;
  try {
    const revisions = await api(`/api/${currentResourceType}/${currentResource.dir_name}/revisions`);
    const container = document.getElementById('revisions-list');
    if (!container) return;
    if (revisions.length === 0) {
      container.innerHTML = '<div style="color:var(--text-muted);font-size:11px;padding:4px 0;">no revisions yet</div>';
      return;
    }
    container.innerHTML = revisions.map(r => {
      const active = viewingRevision && viewingRevision.meta.revision === r.meta.revision ? ' active' : '';
      return `
        <div class="revision-item${active}" onclick="viewRevision('${escAttr(r.filename)}')">
          <span class="revision-label">rev ${r.meta.revision}</span>
          <span class="revision-date">${escHtml(r.meta.created || '')}</span>
        </div>
      `;
    }).join('');
  } catch {
    const container = document.getElementById('revisions-list');
    if (container) container.innerHTML = '<div style="color:var(--text-muted);font-size:11px;">failed to load revisions</div>';
  }
}

function toggleRevisions(el) {
  el.classList.toggle('expanded');
  const list = el.nextElementSibling;
  list.classList.toggle('expanded');
}

async function viewRevision(filename) {
  if (!currentResource || !currentResourceType) return;
  const rev = filename.replace('.md', '');
  try {
    viewingRevision = await api(`/api/${currentResourceType}/${currentResource.dir_name}/revisions/${rev}`);
    renderResourceModal();
  } catch {}
}

function toggleResourceEdit() {
  resourceEditMode = !resourceEditMode;
  viewingRevision = null;
  renderResourceModal();
}

async function saveResourceEdit() {
  if (!currentResource || !currentResourceType) return;
  const body = document.getElementById('resource-edit-body').value;
  try {
    currentResource = await api(`/api/${currentResourceType}/${currentResource.dir_name}`, {
      method: 'PUT',
      body: JSON.stringify({ body }),
    });
    resourceEditMode = false;
    viewingRevision = null;
    renderResourceModal();
    loadResources(currentResourceType);
  } catch {}
}

async function deleteCurrentResource() {
  if (!currentResource || !currentResourceType) return;
  const typeLabel = currentResourceType === 'prompts' ? 'prompt' : 'document';
  if (!confirm(`Delete ${typeLabel} "${currentResource.meta.title}"?`)) return;
  await api(`/api/${currentResourceType}/${currentResource.dir_name}`, { method: 'DELETE' });
  closeResourceModal();
  loadResources(currentResourceType);
}

document.getElementById('resource-modal-backdrop').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeResourceModal();
});

// ── CROSS-LINKING ──
function renderRelatedLinks(related) {
  if (!related || !related.length) return '';
  return related.map(ref => {
    const r = String(ref).trim();
    const m = r.match(/^(task|prompt|document):(\d+)/i);
    if (!m) return `<span style="font-size:11px;color:var(--text-muted);">${escHtml(r)}</span>`;
    const type = m[1].toLowerCase();
    const id = m[2];
    const padded = id.padStart(3, '0');
    const color = type === 'task' ? 'var(--text-accent)' : type === 'prompt' ? 'var(--color-prompt)' : 'var(--color-document)';
    return `<a href="#" onclick="navigateToRelated('${type}','${padded}');return false;" style="display:inline-block;font-size:11px;color:${color};margin-right:6px;text-decoration:none;border-bottom:1px dotted ${color};">${type}:${padded}</a>`;
  }).join('');
}

async function navigateToRelated(type, paddedId) {
  if (type === 'task') {
    // Find task across all columns
    if (!boardData) await loadBoard();
    for (const col of boardData.columns) {
      const task = col.tasks.find(t => {
        const tid = String(t.meta.id).padStart(3, '0');
        return tid === paddedId;
      });
      if (task) {
        closeModal();
        closeResourceModal();
        setTimeout(() => openModal(task), 100);
        return;
      }
    }
  } else {
    const apiType = type === 'prompt' ? 'prompts' : 'documents';
    // Find resource by padded id prefix in dir_name
    try {
      const resources = await api(`/api/${apiType}`);
      const res = resources.find(r => r.dir_name.startsWith(paddedId + '-'));
      if (res) {
        closeModal();
        closeResourceModal();
        setTimeout(() => openResource(apiType, res.dir_name), 100);
        return;
      }
    } catch {}
  }
}

// ── DIFF ──
function computeDiff(oldText, newText) {
  const oldLines = oldText.split('\n');
  const newLines = newText.split('\n');

  // Simple LCS diff
  const m = oldLines.length, n = newLines.length;
  // Build LCS table (space-optimized for small docs)
  const dp = Array.from({length: m + 1}, () => new Uint16Array(n + 1));
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      dp[i][j] = oldLines[i-1] === newLines[j-1]
        ? dp[i-1][j-1] + 1
        : Math.max(dp[i-1][j], dp[i][j-1]);
    }
  }

  // Backtrack to produce diff
  const result = [];
  let i = m, j = n;
  while (i > 0 || j > 0) {
    if (i > 0 && j > 0 && oldLines[i-1] === newLines[j-1]) {
      result.push({type: 'ctx', line: oldLines[i-1]});
      i--; j--;
    } else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) {
      result.push({type: 'add', line: newLines[j-1]});
      j--;
    } else {
      result.push({type: 'del', line: oldLines[i-1]});
      i--;
    }
  }
  result.reverse();

  return result.map(r => {
    const prefix = r.type === 'add' ? '+' : r.type === 'del' ? '-' : ' ';
    const cls = r.type === 'add' ? 'diff-line-add' : r.type === 'del' ? 'diff-line-del' : 'diff-line-ctx';
    return `<div class="${cls}">${prefix} ${escHtml(r.line)}</div>`;
  }).join('');
}

// ── PREVIEW HELPERS ──
function updatePreview(textareaId, previewId) {
  const el = document.getElementById(previewId);
  const ta = document.getElementById(textareaId);
  if (el && ta) el.innerHTML = renderMarkdown(ta.value);
}

function updateEditPreview() {
  const ta = document.getElementById('edit-raw');
  const el = document.getElementById('edit-preview');
  if (!ta || !el) return;
  // Strip frontmatter for preview
  const raw = ta.value;
  const bodyOnly = raw.replace(/^---[\s\S]*?---\n?/, '');
  el.innerHTML = renderMarkdown(bodyOnly);
}

function updateResourceEditPreview() {
  const ta = document.getElementById('resource-edit-body');
  const el = document.getElementById('resource-edit-preview');
  if (ta && el) el.innerHTML = renderMarkdown(ta.value);
}

// ── INIT ──
// Hash-based routing
function initFromHash() {
  const hash = location.hash.replace('#', '');
  if (['board', 'prompts', 'documents', 'activity'].includes(hash)) {
    switchView(hash);
  } else {
    switchView('board');
  }
}
window.addEventListener('hashchange', initFromHash);

loadBoard();
initFromHash();
api('/api/version').then(d => {
  document.getElementById('app-version').textContent = d.version;
  if (d.project) {
    document.getElementById('project-name').textContent = d.project;
    document.title = d.project + ' — mdboard';
  }
}).catch(() => {});

// ── AUTO-REFRESH POLLING ──
let lastHashes = { board: null, prompts: null, documents: null };
async function pollForChanges() {
  try {
    const hashes = await api('/api/poll');
    if (lastHashes.board && hashes.board !== lastHashes.board) {
      loadBoard();
    }
    if (lastHashes.prompts && hashes.prompts !== lastHashes.prompts && currentView === 'prompts') {
      loadResources('prompts');
    }
    if (lastHashes.documents && hashes.documents !== lastHashes.documents && currentView === 'documents') {
      loadResources('documents');
    }
    // Refresh activity if any hash changed
    const anyChanged = lastHashes.board && (
      hashes.board !== lastHashes.board ||
      hashes.prompts !== lastHashes.prompts ||
      hashes.documents !== lastHashes.documents
    );
    if (anyChanged && currentView === 'activity') {
      loadActivity();
    }
    lastHashes = hashes;
  } catch {}
}
// Initial hash fetch
pollForChanges();
setInterval(pollForChanges, 3000);
</script>
</body>
</html>
